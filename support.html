<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì •í˜•ì™¸ê³¼ í†µí•© ìˆ˜ë‚© ê²€ìˆ˜ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --blue: #228be6; --red: #fa5252; --green: #2b8a3e; --yellow: #f08c00; --gray: #868e96;
      --bg: #f6f6f7; --card-bg: rgba(255, 255, 255, 0.85); /* ì¹´ë“œ íˆ¬ëª…ë„ ì„¤ì • */
      --border: #e5e7eb; --thead: #f3f4f6;
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; background: var(--bg); color: #111827;
      font-family: system-ui, -apple-system, 'Apple SD Gothic Neo', sans-serif;
      position: relative; min-height: 100vh;
    }

    /* ë°°ê²½ ì›Œí„°ë§ˆí¬ ë¡œê³  [bitchart ìŠ¤íƒ€ì¼] */
    .watermark {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 400px; max-width: 80vw; height: auto; opacity: 0.05; z-index: -1; pointer-events: none;
      filter: grayscale(1);
    }

    /* ìƒë‹¨ í—¤ë” ë¡œê³  ìŠ¤íƒ€ì¼ */
    header { padding: 30px 16px 10px; text-align: center; }
    header .logo {
      width: 180px; max-width: 70vw; height: auto; display: block; margin: 0 auto 10px;
      filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15); /* ë¡œê³  ì„¸ë ¨ëœ ì²˜ë¦¬ */
    }
    header h2 { font-size: 1.5rem; margin: 0; color: #374151; letter-spacing: -0.5px; }

    .container { width: 100%; max-width: 1550px; margin: 0 auto; padding: 0 20px 40px; }
    
    /* ì¹´ë“œ ë””ìì¸ (íˆ¬ëª…ë„ ì ìš©) */
    .card { 
      background: var(--card-bg); backdrop-filter: blur(10px); /* ìœ ë¦¬ ëŠë‚Œ íš¨ê³¼ */
      border-radius: 16px; padding: 25px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.5);
      margin-bottom: 20px; 
    }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .file-zone { border: 2px dashed #dee2e6; padding: 25px; border-radius: 12px; text-align: center; background: rgba(255,255,255,0.5); }
    
    /* ë¯¸ë‹ˆ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
    .calendar-area { margin-top: 15px; display: none; animation: fadeIn 0.5s; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; max-width: 380px; margin-left: auto; margin-right: auto; }
    .day-btn { padding: 10px 5px; border: 1px solid #e5e7eb; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .day-btn:hover { background: #e7f5ff; }
    .day-btn.active { background: var(--blue); color: white; border-color: var(--blue); box-shadow: 0 4px 12px rgba(34, 139, 230, 0.3); }
    .day-btn.disabled { opacity: 0.3; cursor: not-allowed; border-style: dotted; }

    /* í•„í„° ìŠ¤ìœ„ì¹˜ */
    .filter-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 15px; background: #e7f5ff; border-radius: 12px; }
    .switch-container { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; color: var(--blue); }
    .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ced4da; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--red); }
    input:checked + .slider:before { transform: translateX(22px); }

    .btn-run { width: 100%; padding: 20px; background: var(--blue); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(34, 139, 230, 0.2); }
    .btn-run:hover { background: #1c7ed6; transform: translateY(-1px); }
    
    /* í…Œì´ë¸” íˆ¬ëª…ë„ ë° ìŠ¤íƒ€ì¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: rgba(255,255,255,0.7); font-size: 0.88rem; }
    th { background: var(--thead); padding: 12px; border: 1px solid var(--border); color: #4b5563; font-weight: 600; }
    td { padding: 10px; text-align: center; border: 1px solid var(--border); }
    
    .row-err { background: rgba(255, 82, 82, 0.08); font-weight: bold; }
    .row-misu { background: rgba(134, 142, 150, 0.05); color: var(--gray); }
    .diff-text { color: var(--red); font-weight: bold; }
    .hidden { display: none; }

    /* ê²°ì œ ìˆ˜ë‹¨ ë±ƒì§€ */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.82rem; font-weight: 700; display: inline-block; margin: 1px; }
    .m1 { background: #ebfbee; color: #2b8a3e; border: 1px solid #b2f2bb; } 
    .m2 { background: #fff9db; color: #f08c00; border: 1px solid #ffec99; } 
    .m3 { background: #fff5f5; color: #e03131; border: 1px solid #ffc9c9; } 
    .m6 { background: #f3f0ff; color: #7048e8; border: 1px solid #d0bfff; } 
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<img src="https://www.u-isarang.com/is_images/common/logo.png" class="watermark" alt="ë°°ê²½ ì›Œí„°ë§ˆí¬" />

<header>
  <img src="https://www.u-isarang.com/is_images/common/logo.png" class="logo" alt="ìƒë‹¨ ë¡œê³ " />
  <h2>ìˆ˜ë‚© ë‚´ì—­ í†µí•© ê²€ìˆ˜ ì‹œìŠ¤í…œ</h2>
</header>

<div class="container">
  <div class="card">
    <div class="grid">
      <div class="file-zone">
        <strong>ğŸ“„ 1. ìˆ˜ê¸° ìˆ˜ë‚©ëŒ€ì¥ (í†µí•©ë³¸)</strong>
        <input type="file" id="fileA" style="margin-top:15px; width:100%;" />
        <div id="calendarArea" class="calendar-area">
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>
      </div>
      <div class="file-zone">
        <strong>ğŸ’» 2. ì „ì‚° ì—‘ì…€ (ë¹„íŠ¸/ì˜ì‚¬)</strong>
        <input type="file" id="fileB" style="margin-top:15px; width:100%;" />
        <div id="logB" style="font-size:0.85em; margin-top:15px; color:#6b7280; font-weight:500;">ì „ì‚° íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>
      </div>
    </div>
    <button class="btn-run" onclick="runCheck()">ì˜¤ëŠ˜ì˜ ê²€ìˆ˜ ì‹œì‘í•˜ê¸°</button>
  </div>

  <div id="resCard" class="card" style="display:none;">
    <div class="filter-bar">
      <label class="switch-container">
        <div class="switch">
          <input type="checkbox" id="errToggle" onchange="applyFilter()" />
          <span class="slider"></span>
        </div>
        <span>ë¶ˆì¼ì¹˜ ëª…ë‹¨ë§Œ ë³´ê¸°</span>
      </label>
      <div id="summary" style="font-weight: 700; color: #374151;"></div>
    </div>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th rowspan="2">ì°¨íŠ¸ë²ˆí˜¸</th><th rowspan="2">í™˜ìëª…</th>
            <th colspan="2">í˜„ê¸ˆ+ì´ì²´</th><th colspan="2">ì¹´ë“œ</th>
            <th colspan="2">ì´ì•¡</th><th rowspan="2">ê²€ìˆ˜ê²°ê³¼</th><th rowspan="2">ìˆ˜ë‹¨ìƒì„¸</th>
          </tr>
          <tr>
            <th>ìˆ˜ê¸°</th><th>ì „ì‚°</th><th>ìˆ˜ê¸°</th><th>ì „ì‚°</th><th>ìˆ˜ê¸°</th><th>ì „ì‚°</th>
          </tr>
        </thead>
        <tbody id="resBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  let currentWbA = null, dbA = [], dbB = [], confA = null, confB = null;
  const methodNames = { 1: "í˜„ê¸ˆ", 2: "ì¹´ë“œ", 3: "ë¯¸ìˆ˜", 4: "ë¯¸ìˆ˜(í˜„)", 5: "ë¯¸ìˆ˜(ì¹´)", 6: "ì´ì²´" };
  
  const norm = (s) => String(s || "").trim().replace(/\s/g, "");
  const toN = (v) => Math.round(Number(String(v || 0).replace(/[^0-9.-]+/g, ""))) || 0;
  const normId = (id) => String(id || "").trim().replace(/^0+/, "");

  const TAGS = {
    id: ['ì°¨íŠ¸ë²ˆí˜¸', 'ì± íŠ¸ë²ˆí˜¸', 'ë“±ë¡ë²ˆí˜¸'],
    name: ['ì„±ëª…', 'ìˆ˜ì§„ìëª…', 'ìˆ˜ì§„ì', 'ì´ë¦„'],
    total: ['ì›ë¬´ê³¼ì…ê¸ˆì•¡', 'ìˆ˜ë‚©ì•¡', 'ìˆ˜ë‚©ì•¡í•©ê³„', 'í•©ê³„'],
    cash: ['í˜„ê¸ˆìˆ˜ë‚©ì•¡', 'í˜„ê¸ˆê¸ˆì•¡', 'í˜„ê¸ˆ'],
    card: ['ì¹´ë“œìˆ˜ë‚©ì•¡', 'ì¹´ë“œê¸ˆì•¡', 'ì¹´ë“œ'],
    acc: ['ê³„ì¢Œì´ì²´ì•¡', 'ê³„ì¢Œê¸ˆì•¡', 'ê³„ì¢Œ']
  };

  function getMap(rows, side) {
    for (let i = 0; i < Math.min(rows.length, 50); i++) {
      const row = rows[i]; if (!row) continue;
      const map = {};
      row.forEach((cell, idx) => {
        const c = norm(cell);
        for (let k in TAGS) { if (TAGS[k].includes(c)) map[k] = idx; }
        if (side === 'A') {
          if (String(cell).includes("ê¸ˆ") && String(cell).includes("ì•¡") && idx < 10) map.total = idx;
          if (c.includes("ìˆ˜ë‹¨(ì…ë ¥)")) map.method = idx;
        }
      });
      if (map.id !== undefined) return { index: i, map };
    }
    return null;
  }

  document.getElementById('fileA').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      currentWbA = XLSX.read(data, { type: 'array' });
      renderCalendar();
    };
    reader.readAsArrayBuffer(e.target.files[0]);
  };

  function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = "";
    const today = new Date().getDate();
    const sheetList = currentWbA.SheetNames.map(n => norm(n));
    for (let i = 1; i <= 31; i++) {
      const btn = document.createElement('button');
      btn.className = 'day-btn'; btn.innerText = i;
      const exists = sheetList.includes(i.toString());
      if (!exists) btn.classList.add('disabled');
      if (i === today && exists) { btn.classList.add('active'); loadSheetData(i.toString()); }
      btn.onclick = () => {
        if (!exists) return;
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); loadSheetData(i.toString());
      };
      grid.appendChild(btn);
    }
    document.getElementById('calendarArea').style.display = "block";
  }

  function loadSheetData(day) {
    const ws = currentWbA.Sheets[day];
    const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
    const res = getMap(raw, 'A');
    confA = { data: raw.slice(res ? res.index+1 : 0), map: res ? res.map : {} };
    dbA = confA.data;
  }

  document.getElementById('fileB').onchange = async (e) => {
    const r = new FileReader();
    r.onload = (e) => {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: "" });
      const res = getMap(raw, 'B');
      confB = { data: raw.slice(res ? res.index+1 : 0), map: res ? res.map : {} };
      dbB = confB.data;
      document.getElementById('logB').innerText = res ? `âœ… ì „ì‚° í•­ëª© ë¡œë“œ ì™„ë£Œ` : "âŒ ì „ì‚° í•­ëª© ì¸ì‹ ì‹¤íŒ¨";
    };
    r.readAsArrayBuffer(e.target.files[0]);
  };

  function runCheck() {
    if (!dbA.length || !dbB.length) return alert("íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    const body = document.getElementById('resBody'); body.innerHTML = "";
    const aggA = new Map(), aggB = new Map();

    dbA.forEach(row => {
      const id = normId(row[confA.map.id]);
      if (!id || isNaN(id) || !row[confA.map.name]) return;
      if(!aggA.has(id)) aggA.set(id, { name: row[confA.map.name], cash: 0, card: 0, total: 0, methods: new Set() });
      const ent = aggA.get(id);
      const amt = toN(row[confA.map.total]), met = parseInt(row[confA.map.method]);
      if ([1, 4, 6].includes(met)) ent.cash += amt; else if ([2, 5].includes(met)) ent.card += amt;
      ent.total += amt; if(met) ent.methods.add(met);
    });

    dbB.forEach(row => {
      const id = normId(row[confB.map.id]); if(!id) return;
      if(!aggB.has(id)) aggB.set(id, { cash: 0, card: 0, total: 0 });
      const ent = aggB.get(id), m = confB.map;
      ent.cash += (toN(row[m.cash]) + toN(row[m.acc]));
      ent.card += toN(row[m.card]);
      ent.total += (toN(row[m.total]) || (ent.cash + ent.card));
    });

    let totalCnt = 0, errCnt = 0;
    aggA.forEach((dataA, id) => {
      totalCnt++;
      const dataB = aggB.get(id) || { cash: 0, card: 0, total: 0 };
      const misuOnly = dataA.methods.size === 1 && dataA.methods.has(3);
      const dTot = dataA.total - dataB.total, dCash = dataA.cash - dataB.cash, dCard = dataA.card - dataB.card;

      let res = "ì •ìƒ", isErr = false;
      if (!aggB.has(id) && !misuOnly) { res = "ì „ì‚°ëˆ„ë½"; isErr = true; }
      else if (dTot !== 0 && !misuOnly) { res = "ì´ì•¡ì˜¤ë¥˜"; isErr = true; }
      else if ((Math.abs(dCash) > 50 || Math.abs(dCard) > 50) && !misuOnly) { res = "ìˆ˜ë‹¨ì˜¤ë¥˜"; isErr = true; }
      else if (misuOnly) res = "ë¯¸ìˆ˜ëŒ€ê¸°";

      if (isErr) errCnt++;
      const tr = document.createElement('tr');
      tr.dataset.error = isErr;
      if (isErr) tr.className = "row-err"; else if (misuOnly) tr.className = "row-misu";

      tr.innerHTML = `
        <td>${id}</td><td>${dataA.name}</td>
        <td class="${dCash!==0?'diff-text':''}">${dataA.cash.toLocaleString()}</td><td>${dataB.cash.toLocaleString()}</td>
        <td class="${dCard!==0?'diff-text':''}">${dataA.card.toLocaleString()}</td><td>${dataB.card.toLocaleString()}</td>
        <td class="${dTot!==0?'diff-text':''}">${dataA.total.toLocaleString()}</td><td>${dataB.total.toLocaleString()}</td>
        <td style="color:${isErr?'red':(misuOnly?'var(--gray)':'var(--blue)')}"><b>${res}</b></td>
        <td>${Array.from(dataA.methods).map(m => `<span class="badge m${m}">${methodNames[m]||m}</span>`).join(' ')}</td>
      `;
      body.appendChild(tr);
    });

    document.getElementById('summary').innerText = `ì´ ${totalCnt}ê±´ ëŒ€ì¡° / ë¶ˆì¼ì¹˜ ${errCnt}ê±´`;
    document.getElementById('resCard').style.display = "block";
    applyFilter();
  }

  function applyFilter() {
    const onlyErr = document.getElementById('errToggle').checked;
    document.querySelectorAll('#resBody tr').forEach(tr => {
      tr.classList.toggle('hidden', onlyErr && tr.dataset.error === 'false');
    });
  }
</script>
</body>
</html>
